"use client";

import { useEffect, useState } from "react";
import { AnimatePresence, motion } from "motion/react";

export default function ThemeToggle() {
  const [theme, setTheme] = useState<"light" | "dark">(() => {
    // This runs ONLY on first render
    if (typeof window === "undefined") return "light";

    const saved = localStorage.getItem("theme") as "light" | "dark" | null;

    if (saved) {
      document.documentElement.classList.toggle("dark", saved === "dark");
      return saved;
    }

    const prefersDark = window.matchMedia(
      "(prefers-color-scheme: dark)"
    ).matches;
    document.documentElement.classList.toggle("dark", prefersDark);

    return prefersDark ? "dark" : "light";
  });

  // Listen for theme changes across tabs/windows
  useEffect(() => {
    const handleThemeChange = (e: CustomEvent<"light" | "dark">) => {
      setTheme(e.detail);
      document.documentElement.classList.toggle("dark", e.detail === "dark");
    };

    window.addEventListener("themeChange", handleThemeChange as EventListener);
    return () => {
      window.removeEventListener(
        "themeChange",
        handleThemeChange as EventListener
      );
    };
  }, []);

  const toggleTheme = () => {
    const next = theme === "light" ? "dark" : "light";
    setTheme(next);

    localStorage.setItem("theme", next);
    document.documentElement.classList.toggle("dark", next === "dark");

    window.dispatchEvent(new CustomEvent("themeChange", { detail: next }));
  };

  const isChecked = theme === "dark";
  return (
    <>
      <button
        onClick={toggleTheme}
        className="flex items-center justify-center w-10 h-10 rounded-lg cursor-pointer transition-colors duration-300 mr-10 relative overflow-hidden"
      >
        <AnimatePresence mode="wait" initial={false}>
          {isChecked ? (
            <motion.div
              key="sun"
              initial={{ opacity: 0, rotate: -90, scale: 0.5 }}
              animate={{ opacity: 1, rotate: 0, scale: 1 }}
              exit={{ opacity: 0, rotate: 90, scale: 0.5 }}
              transition={{ duration: 0.4, ease: "easeInOut" }}
              className="absolute"
            >
              <svg
                className="xs:w-5 xs:h-5 sm:w-[27.19px] sm:h-[27.19px] md:w-8 md:h-8 lg:w-[35.62499237060547px] lg:h-[35.62499237060547px] xl:w-10 xl:h-10 2xl:w-10 2xl:h-10"
                viewBox="0 0 40 40"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M18.6382 5.32519V1.3313C18.6382 0.978216 18.7784 0.639595 19.0281 0.389928C19.2778 0.140261 19.6164 0 19.9695 0C20.3226 0 20.6612 0.140261 20.9109 0.389928C21.1605 0.639595 21.3008 0.978216 21.3008 1.3313V5.32519C21.3008 5.67828 21.1605 6.0169 20.9109 6.26656C20.6612 6.51623 20.3226 6.65649 19.9695 6.65649C19.6164 6.65649 19.2778 6.51623 19.0281 6.26656C18.7784 6.0169 18.6382 5.67828 18.6382 5.32519ZM30.6199 19.9695C30.6199 22.0759 29.9952 24.1351 28.825 25.8865C27.6547 27.638 25.9913 29.0031 24.0452 29.8092C22.0991 30.6153 19.9577 30.8262 17.8917 30.4152C15.8257 30.0043 13.928 28.9899 12.4385 27.5004C10.949 26.011 9.93468 24.1132 9.52374 22.0473C9.11279 19.9813 9.3237 17.8399 10.1298 15.8938C10.9359 13.9476 12.301 12.2843 14.0524 11.114C15.8039 9.94372 17.863 9.31909 19.9695 9.31909C22.7932 9.32217 25.5004 10.4453 27.497 12.4419C29.4937 14.4386 30.6168 17.1458 30.6199 19.9695ZM27.9573 19.9695C27.9573 18.3896 27.4888 16.8453 26.6111 15.5317C25.7334 14.2181 24.4859 13.1943 23.0263 12.5897C21.5667 11.9851 19.9606 11.827 18.4111 12.1352C16.8617 12.4434 15.4384 13.2041 14.3213 14.3213C13.2041 15.4384 12.4434 16.8617 12.1352 18.4111C11.827 19.9606 11.9851 21.5667 12.5897 23.0263C13.1943 24.4859 14.2181 25.7334 15.5317 26.6111C16.8453 27.4888 18.3896 27.9573 19.9695 27.9573C22.0873 27.9551 24.1177 27.1128 25.6153 25.6153C27.1128 24.1177 27.9551 22.0873 27.9573 19.9695ZM8.3772 10.261C8.627 10.5108 8.96581 10.6511 9.31909 10.6511C9.67237 10.6511 10.0112 10.5108 10.261 10.261C10.5108 10.0112 10.6511 9.67237 10.6511 9.31909C10.6511 8.96581 10.5108 8.627 10.261 8.3772L7.59839 5.7146C7.34858 5.46479 7.00977 5.32445 6.65649 5.32445C6.30321 5.32445 5.96441 5.46479 5.7146 5.7146C5.46479 5.96441 5.32445 6.30321 5.32445 6.65649C5.32445 7.00977 5.46479 7.34858 5.7146 7.59839L8.3772 10.261ZM8.3772 29.678L5.7146 32.3406C5.46479 32.5904 5.32445 32.9292 5.32445 33.2825C5.32445 33.6357 5.46479 33.9746 5.7146 34.2244C5.96441 34.4742 6.30321 34.6145 6.65649 34.6145C7.00977 34.6145 7.34858 34.4742 7.59839 34.2244L10.261 31.5618C10.3847 31.4381 10.4828 31.2912 10.5497 31.1296C10.6167 30.968 10.6511 30.7948 10.6511 30.6199C10.6511 30.4449 10.6167 30.2717 10.5497 30.1101C10.4828 29.9485 10.3847 29.8017 10.261 29.678C10.1373 29.5543 9.99045 29.4562 9.82884 29.3892C9.66723 29.3223 9.49402 29.2878 9.31909 29.2878C9.14416 29.2878 8.97095 29.3223 8.80934 29.3892C8.64773 29.4562 8.50089 29.5543 8.3772 29.678ZM30.6199 10.6504C30.7947 10.6505 30.9679 10.6162 31.1296 10.5494C31.2912 10.4826 31.438 10.3846 31.5618 10.261L34.2244 7.59839C34.4742 7.34858 34.6145 7.00977 34.6145 6.65649C34.6145 6.30321 34.4742 5.96441 34.2244 5.7146C33.9746 5.46479 33.6357 5.32445 33.2825 5.32445C32.9292 5.32445 32.5904 5.46479 32.3406 5.7146L29.678 8.3772C29.4916 8.56339 29.3646 8.80069 29.3132 9.05908C29.2617 9.31746 29.2881 9.58531 29.3889 9.8287C29.4898 10.0721 29.6606 10.2801 29.8797 10.4264C30.0988 10.5726 30.3564 10.6506 30.6199 10.6504ZM31.5618 29.678C31.312 29.4282 30.9731 29.2878 30.6199 29.2878C30.2666 29.2878 29.9278 29.4282 29.678 29.678C29.4282 29.9278 29.2878 30.2666 29.2878 30.6199C29.2878 30.9731 29.4282 31.312 29.678 31.5618L32.3406 34.2244C32.4643 34.348 32.6111 34.4462 32.7727 34.5131C32.9343 34.58 33.1075 34.6145 33.2825 34.6145C33.4574 34.6145 33.6306 34.58 33.7922 34.5131C33.9538 34.4462 34.1007 34.348 34.2244 34.2244C34.348 34.1007 34.4462 33.9538 34.5131 33.7922C34.58 33.6306 34.6145 33.4574 34.6145 33.2825C34.6145 33.1075 34.58 32.9343 34.5131 32.7727C34.4462 32.6111 34.348 32.4643 34.2244 32.3406L31.5618 29.678ZM6.65649 19.9695C6.65649 19.6164 6.51623 19.2778 6.26656 19.0281C6.0169 18.7784 5.67828 18.6382 5.32519 18.6382H1.3313C0.978216 18.6382 0.639595 18.7784 0.389928 19.0281C0.140261 19.2778 0 19.6164 0 19.9695C0 20.3226 0.140261 20.6612 0.389928 20.9109C0.639595 21.1605 0.978216 21.3008 1.3313 21.3008H5.32519C5.67828 21.3008 6.0169 21.1605 6.26656 20.9109C6.51623 20.6612 6.65649 20.3226 6.65649 19.9695ZM19.9695 33.2825C19.6164 33.2825 19.2778 33.4227 19.0281 33.6724C18.7784 33.9221 18.6382 34.2607 18.6382 34.6138V38.6077C18.6382 38.9607 18.7784 39.2994 19.0281 39.549C19.2778 39.7987 19.6164 39.939 19.9695 39.939C20.3226 39.939 20.6612 39.7987 20.9109 39.549C21.1605 39.2994 21.3008 38.9607 21.3008 38.6077V34.6138C21.3008 34.2607 21.1605 33.9221 20.9109 33.6724C20.6612 33.4227 20.3226 33.2825 19.9695 33.2825ZM38.6077 18.6382H34.6138C34.2607 18.6382 33.9221 18.7784 33.6724 19.0281C33.4227 19.2778 33.2825 19.6164 33.2825 19.9695C33.2825 20.3226 33.4227 20.6612 33.6724 20.9109C33.9221 21.1605 34.2607 21.3008 34.6138 21.3008H38.6077C38.9607 21.3008 39.2994 21.1605 39.549 20.9109C39.7987 20.6612 39.939 20.3226 39.939 19.9695C39.939 19.6164 39.7987 19.2778 39.549 19.0281C39.2994 18.7784 38.9607 18.6382 38.6077 18.6382Z"
                  fill="white"
                />
              </svg>
            </motion.div>
          ) : (
            <motion.div
              key="moon"
              initial={{ opacity: 0, rotate: 90, scale: 0.5 }}
              animate={{ opacity: 1, rotate: 0, scale: 1 }}
              exit={{ opacity: 0, rotate: -90, scale: 0.5 }}
              transition={{ duration: 0.4, ease: "easeInOut" }}
              className="absolute"
            >
              <svg
                className="xs:w-5 xs:h-5 sm:w-[27.19px] sm:h-[27.19px] md:w-8 md:h-8 lg:w-[35.62499237060547px] lg:h-[35.62499237060547px] xl:w-10 xl:h-10 2xl:w-10 2xl:h-10"
                viewBox="0 0 30 30"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M29 16.2613C28.7548 18.9148 27.7589 21.4436 26.129 23.5517C24.499 25.6599 22.3023 27.2603 19.796 28.1656C17.2897 29.0709 14.5774 29.2437 11.9764 28.6637C9.37551 28.0838 6.99353 26.7751 5.10923 24.8908C3.22492 23.0065 1.91623 20.6245 1.33628 18.0236C0.756336 15.4226 0.929121 12.7103 1.83442 10.204C2.73972 7.69767 4.34009 5.50101 6.44827 3.87104C8.55645 2.24107 11.0852 1.24522 13.7387 1C12.1852 3.10176 11.4376 5.69132 11.632 8.29768C11.8263 10.904 12.9497 13.3541 14.7978 15.2022C16.6459 17.0503 19.096 18.1737 21.7023 18.368C24.3087 18.5624 26.8982 17.8148 29 16.2613Z"
                  stroke="#1E1E1E"
                  strokeWidth="2"
                  strokeLinecap="round"
                  strokeLinejoin="round"
                />
              </svg>
            </motion.div>
          )}
        </AnimatePresence>
      </button>
    </>
  );
}
